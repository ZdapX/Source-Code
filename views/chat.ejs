<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMMS_ // <%= adminTarget %></title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="height: 100vh; display: flex; flex-direction: column;">
    
    <!-- Top Secure Bar -->
    <div style="background: var(--glass); backdrop-filter: blur(20px); border-bottom: 1px solid var(--zinc-800); padding: 1.5rem 5%; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <p class="mono" style="color: var(--accent); font-size: 0.7rem; margin-bottom: 0.2rem;">[ SECURE_CHANNEL_ACTIVE ]</p>
            <h2 style="font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.1em;">TARGET: <%= adminTarget %></h2>
        </div>
        <div class="mono" style="font-size: 0.7rem; text-align: right; opacity: 0.5;">
            ENCRYPTION: AES_256<br>
            STATUS: CONNECTED
        </div>
    </div>

    <!-- Chat Messages Area -->
    <div id="chat-window" style="flex: 1; overflow-y: auto; padding: 4rem 15%; display: flex; flex-direction: column; gap: 2rem;">
        <% history.forEach(m => { %>
            <div style="display: flex; flex-direction: column; <%= (m.user === adminTarget || m.isAdmin) ? 'align-items: flex-start' : 'align-items: flex-end' %>">
                <p class="mono" style="font-size: 0.6rem; margin-bottom: 0.5rem; opacity: 0.4;"><%= m.user %> // <%= m.timestamp %></p>
                <div style="
                    background: <%= (m.user === adminTarget || m.isAdmin) ? 'var(--zinc-900)' : '#050505' %>;
                    border: 1px solid <%= (m.user === adminTarget || m.isAdmin) ? 'var(--zinc-800)' : 'var(--accent)' %>;
                    padding: 1.2rem 2rem;
                    border-radius: 2rem;
                    max-width: 600px;
                    line-height: 1.6;
                ">
                    <%= m.text %>
                </div>
            </div>
        <% }) %>
    </div>

    <!-- Floating Pill Input -->
    <div style="padding: 2rem 15% 4rem 15%; background: linear-gradient(to top, var(--bg) 60%, transparent);">
        <div style="background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--zinc-800); border-radius: 4rem; padding: 0.8rem; display: flex; gap: 1rem; align-items: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <input id="chat-input" class="cyber-input" style="border: none; background: transparent; padding: 1rem 2rem;" placeholder="TYPE_MESSAGE_TO_ADMIN...">
            <button onclick="send()" class="btn-glow" style="padding: 1rem 3rem;">SEND_</button>
        </div>
    </div>

    <nav class="nav-floating">
        <a href="/chat-pilih" class="nav-link">DISCONNECT</a>
    </nav>

    <script>
        const socket = io();
        const target = "<%= adminTarget %>";
        const sessionUser = "<%= sessionUser %>";
        const myName = sessionUser === target ? target : "USER_" + Math.floor(Math.random()*9999);

        function send() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            socket.emit('chat message', {
                user: myName,
                text: input.value,
                to: target,
                isAdmin: myName === target
            });
            input.value = '';
        }

        socket.on('chat message', (data) => {
            if(data.to === target) {
                const box = document.getElementById('chat-window');
                const isMe = data.user === myName;
                const div = document.createElement('div');
                div.style = `display: flex; flex-direction: column; ${isMe ? 'align-items: flex-end' : 'align-items: flex-start'}`;
                div.innerHTML = `
                    <p class="mono" style="font-size: 0.6rem; margin-bottom: 0.5rem; opacity: 0.4;">${data.user} // JUST_NOW</p>
                    <div style="
                        background: ${!isMe ? 'var(--zinc-900)' : '#050505'};
                        border: 1px solid ${!isMe ? 'var(--zinc-800)' : 'var(--accent)'};
                        padding: 1.2rem 2rem;
                        border-radius: 2rem;
                        max-width: 600px;
                        line-height: 1.6;
                    ">${data.text}</div>
                `;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        });
    </script>
</body>
</html>
