
<!DOCTYPE html>
<html>
<head>
    <title>Chat with <%= adminTarget %></title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .msg { margin: 10px; padding: 10px; border-radius: 10px; max-width: 70%; }
        .me { align-self: flex-end; background: red; color: white; }
        .other { align-self: flex-start; background: #333; color: white; }
    </style>
</head>
<body style="background:#000; color:white;">
    <div style="max-width:600px; margin:auto; height:100vh; display:flex; flex-direction:column; border:1px solid red;">
        <div style="background:#111; padding:20px; text-align:center; border-bottom:2px solid red;">
            CHAT DENGAN: <span style="color:red; font-weight:bold;"><%= adminTarget %></span>
        </div>
        <div id="msgs" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; padding:10px;">
            <% history.forEach(m => { %>
                <div class="msg <%= (m.isAdmin && sessionUser === adminTarget) || (!m.isAdmin && m.user.startsWith('USER')) ? 'me' : 'other' %>">
                    <small><%= m.user %></small><br><%= m.text %>
                </div>
            <% }) %>
        </div>
        <div style="padding:10px; display:flex; background:#111;">
            <input id="i" placeholder="Tulis pesan..." style="flex:1; padding:10px; background:#000; color:white; border:1px solid red;">
            <button onclick="send()" class="btn-info">KIRIM</button>
        </div>
    </div>
    <script>
        const socket = io();
        const adminTarget = "<%= adminTarget %>";
        const sessionUser = "<%= sessionUser %>";
        const userId = sessionUser === adminTarget ? adminTarget : "USER_" + Math.floor(Math.random()*999);

        function send(){
            const i = document.getElementById('i');
            if(!i.value) return;
            socket.emit('chat message', {
                user: userId,
                text: i.value,
                to: adminTarget,
                isAdmin: userId === adminTarget
            });
            i.value = '';
        }

        socket.on('chat message', (m) => {
            if(m.to === adminTarget){
                const div = document.createElement('div');
                div.className = "msg " + (m.user === userId ? "me" : "other");
                div.innerHTML = `<small>${m.user}</small><br>${m.text}`;
                document.getElementById('msgs').appendChild(div);
                document.getElementById('msgs').scrollTop = document.getElementById('msgs').scrollHeight;
            }
        });
    </script>
</body>
</html>
