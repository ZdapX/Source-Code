<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat | <%= adminTarget %></title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div style="max-height: 100vh; display: flex; flex-direction: column; height: 100vh;">
        <div style="padding: 30px; background: var(--secondary); border-bottom: 4px solid var(--primary); text-align: center;">
            <h2 style="font-family: var(--font-pixel); font-size: 0.9rem;">
                SECURE_CONNECTION: <span style="color: var(--primary);"><%= adminTarget %></span>
            </h2>
        </div>

        <div id="chat-box" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: var(--bg);">
            <% history.forEach(m => { %>
                <div class="msg <%= (m.user === adminTarget || m.isAdmin) ? 'other' : 'me' %>">
                    <small style="display:block; font-family: var(--font-pixel); font-size: 0.5rem; margin-bottom: 5px;">
                        <%= m.user %>
                    </small>
                    <%= m.text %>
                </div>
            <% }) %>
        </div>

        <div style="padding: 20px; background: var(--secondary); display: flex; gap: 10px;">
            <input id="m-input" style="flex: 1; background: #000; border: 2px solid var(--border-color); color: white; padding: 15px; outline: none;" placeholder="Enter message_">
            <button onclick="send()" class="btn-modern">SEND</button>
        </div>
    </div>

    <script>
        const socket = io();
        const target = "<%= adminTarget %>";
        const sessionUser = "<%= sessionUser %>";
        const myName = sessionUser === target ? target : "USER_" + Math.floor(Math.random()*9999);

        function send() {
            const input = document.getElementById('m-input');
            if(!input.value) return;
            socket.emit('chat message', {
                user: myName,
                text: input.value,
                to: target,
                isAdmin: myName === target
            });
            input.value = '';
        }

        socket.on('chat message', (data) => {
            if(data.to === target) {
                const box = document.getElementById('chat-box');
                const div = document.createElement('div');
                div.className = `msg ${data.user === myName ? 'me' : 'other'}`;
                div.innerHTML = `<small style="display:block; font-family: var(--font-pixel); font-size: 0.5rem; margin-bottom: 5px;">${data.user}</small>${data.text}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        });
    </script>
</body>
</html>
